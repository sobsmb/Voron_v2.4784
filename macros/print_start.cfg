#####################################################################
#   PRINT_VARS – store info between PRINT_START and PRINT_END
#####################################################################

[gcode_macro PRINT_VARS]
variable_material: "PLA"
gcode:
    # No-op macro, just used to store data between PRINT_START and PRINT_END
    # Access via: printer["gcode_macro PRINT_VARS"].material
    M118 PRINT_VARS: material currently '${printer["gcode_macro PRINT_VARS"].material}'


#####################################################################
#   PRINT_START – main start sequence
#####################################################################

[gcode_macro PRINT_START]
gcode:
    M118 ============= PRINT_START BEGIN =============
    SET_DISPLAY_TEXT MSG="Print start: init..."

    {% set INITEXTRUDER    = params.INITEXTRUDER|default(0)|int %}
    {% set BED             = params.BED|default(65)|float %}
    {% set BED_TEMP        = params.BED_TEMP|default(0)|float %}
    {% set EXTRUDER        = params.EXTRUDER|default(210)|float %}
    {% set EXTRUDER_TEMP   = params.EXTRUDER_TEMP|default(0)|float %}
    {% set MATERIAL        = params.MATERIAL|default("PLA")|string %}
    {% set PRINT_FLOW_RATE = params.FLOW_RATE|default(100)|int %}
    {% set Z_OFFSET        = params.Z_OFFSET|default(-0.110)|float %}
    {% set CHAMBER_TEMP    = params.CHAMBER_TEMP|default(0)|float %}

    M118 PRINT_START: Material={MATERIAL}, Bed={BED}C, Nozzle={EXTRUDER}C
    SET_DISPLAY_TEXT MSG="Mat:{MATERIAL} Bed:{BED}C Noz:{EXTRUDER}C"

    # Store material for PRINT_END
    M118 PRINT_START: Storing material for end macro...
    SET_GCODE_VARIABLE MACRO=PRINT_VARS VARIABLE=material VALUE="'{MATERIAL}'"

    # Clear any previous PC anneal timer
    M118 PRINT_START: Clearing previous PC anneal timers...
    UPDATE_DELAYED_GCODE ID=PC_ANNEAL_END DURATION=0

    # Allow override temps if provided
    {% if EXTRUDER_TEMP > 0 %}
        M118 PRINT_START: Overriding nozzle temp -> {EXTRUDER_TEMP}C
        {% set EXTRUDER = EXTRUDER_TEMP %}
    {% endif %}
    {% if BED_TEMP > 0 %}
        M118 PRINT_START: Overriding bed temp -> {BED_TEMP}C
        {% set BED = BED_TEMP %}
    {% endif %}

    # Wake system
    M118 PRINT_START: Waking up printer + Pi fan...
    SET_DISPLAY_TEXT MSG="Waking up..."
    WAKEUP
    PI_FAN_PRINT

    # Quick "system check" phase
    M118 PRINT_START: System check - heaters & fans...
    SET_DISPLAY_TEXT MSG="System check..."
    ; (If something critical was missing you'd catch it as errors anyway)

    # Clear last bed mesh
    {% if printer.configfile.config["bed_mesh"] %}
        M118 PRINT_START: Clearing previous bed mesh...
        BED_MESH_CLEAR
    {% endif %}

    STATUS_BUSY
    M118 PRINT_START: Heating bed to {BED}C...
    SET_DISPLAY_TEXT MSG="Heating bed -> {BED}C"
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={BED}

    G21           ; mm
    M220 S100     ; speed 100%
    M221 S100     ; flow 100%
    M107          ; part cooling off

    # Fan & mesh config per material
    M118 PRINT_START: Configuring fans & mesh for {MATERIAL}...
    {% set MESH = "default" %}

    {% if MATERIAL == "PLA" %}
        M118 PRINT_START: PLA profile active
        {% if printer['fan_generic cooling_fan'] %}
            SET_FAN_SPEED FAN=cooling_fan SPEED=1.00
        {% endif %}
        {% if printer['fan_generic intake_fan'] %}
            SET_FAN_SPEED FAN=intake_fan SPEED=1.00
        {% endif %}
        {% if printer['fan_generic exhaust_fan'] %}
            SET_FAN_SPEED FAN=exhaust_fan SPEED=1.00
        {% endif %}

    {% elif MATERIAL == "PETG" %}
        M118 PRINT_START: PETG profile active
        {% if printer['fan_generic cooling_fan'] %}
            SET_FAN_SPEED FAN=cooling_fan SPEED=0.50
        {% endif %}
        {% if printer['fan_generic intake_fan'] %}
            SET_FAN_SPEED FAN=intake_fan SPEED=0.50
        {% endif %}
        {% if printer['fan_generic exhaust_fan'] %}
            SET_FAN_SPEED FAN=exhaust_fan SPEED=0.50
        {% endif %}
        {% if printer['fan_generic Nevermore'] %}
            SET_FAN_SPEED FAN=Nevermore SPEED=0.50
        {% endif %}
        {% set MESH = "default_petg" %}

    {% elif MATERIAL == "ABS" %}
        M118 PRINT_START: ABS profile active
        {% if printer['fan_generic Nevermore'] %}
            SET_FAN_SPEED FAN=Nevermore SPEED=1.00
        {% endif %}
        {% set MESH = "default_abs" %}

    {% elif MATERIAL == "ASA" %}
        M118 PRINT_START: ASA profile active
        {% if printer['fan_generic Nevermore'] %}
            SET_FAN_SPEED FAN=Nevermore SPEED=1.00
        {% endif %}
        {% set MESH = "default_abs" %}

    {% elif MATERIAL == "PC" %}
        M118 PRINT_START: PC profile active
        {% if printer['fan_generic Nevermore'] %}
            SET_FAN_SPEED FAN=Nevermore SPEED=1.00
        {% endif %}
        {% set MESH = "default_abs" %}

    {% elif MATERIAL == "TPU" %}
        M118 PRINT_START: TPU profile active
        {% if printer['fan_generic exhaust_fan'] %}
            SET_FAN_SPEED FAN=exhaust_fan SPEED=0.25
        {% endif %}
    {% else %}
        M118 PRINT_START: Other material profile
    {% endif %}

    # Clean nozzle
    M118 PRINT_START: Cleaning nozzle...
    SET_DISPLAY_TEXT MSG="Cleaning nozzle..."
    status_cleaning
    NOZZLE_START_CLEAN

    # Wait for bed
    M118 PRINT_START: Waiting for bed to reach {BED}C...
    SET_DISPLAY_TEXT MSG="Bed -> {BED}C (heating)"
    STATUS_HEATING
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={BED}
    STATUS_READY
    M118 PRINT_START: Bed at temperature.

    # Chamber heating if requested
    {% if CHAMBER_TEMP > 20 %}
        M118 PRINT_START: Waiting for chamber to reach {CHAMBER_TEMP}C...
        SET_DISPLAY_TEXT MSG="Chamber -> {CHAMBER_TEMP}C"
        TEMPERATURE_WAIT SENSOR="temperature_sensor chamber_th" MINIMUM={CHAMBER_TEMP}
        M118 PRINT_START: Chamber at temperature.
    {% endif %}

    # QGL
    M118 PRINT_START: Running QGL...
    SET_DISPLAY_TEXT MSG="QGL running..."
    status_leveling
    G32

    # Load bed mesh
    M118 PRINT_START: Loading mesh '{MESH}'...
    SET_DISPLAY_TEXT MSG="Load mesh: {MESH}"
    BED_MESH_PROFILE LOAD="{MESH}"

    # Heat nozzle
    M118 PRINT_START: Heating nozzle to {EXTRUDER}C...
    SET_DISPLAY_TEXT MSG="Nozzle -> {EXTRUDER}C"
    STATUS_HEATING
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={EXTRUDER}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={EXTRUDER}
    STATUS_READY
    M118 PRINT_START: Nozzle at temperature.

    # Flow
    M118 PRINT_START: Flow rate {PRINT_FLOW_RATE}%...
    M221 S{PRINT_FLOW_RATE}

    M400  ; clear buffer

    STATUS_PRINTING
    SET_DISPLAY_TEXT MSG="Printing..."
    M118 ============= PRINT_START COMPLETE =============