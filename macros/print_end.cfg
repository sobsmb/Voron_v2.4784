#####################################################################
#   PC_ANNEAL_END – shut down after PC anneal
#####################################################################

[delayed_gcode PC_ANNEAL_END]
gcode:
    M118 ==== PC Anneal Complete ====
    M118 Turning off bed and Nevermore...
    SET_DISPLAY_TEXT MSG="Anneal done - remove part"

    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0

    {% if printer['fan_generic Nevermore'] %}
        SET_FAN_SPEED FAN=Nevermore SPEED=0
    {% endif %}

    UPDATE_DELAYED_GCODE ID=PC_ANNEAL_END DURATION=0
    M118 =============================


#####################################################################
#   PRINT_END – main end sequence
#####################################################################

[gcode_macro PRINT_END]
description: End print and tidy up (retract filament, move toolhead, turn off heaters)
gcode:
    M118 ================ PRINT_END BEGIN ================
    SET_DISPLAY_TEXT MSG="Print end..."

    {% set unload        = params.UNLOAD_AT_END|default(0)|int %}
    {% set last_material = printer["gcode_macro PRINT_VARS"].material %}

    M118 PRINT_END: Last material was '{last_material}'
    STATUS_BUSY
    M400

    # Optional MMU unload
    {% if unload == 1 %}
        M118 PRINT_END: Unloading filament (MMU)...
        MMU_EJECT
    {% endif %}

    # Get boundaries
    {% set max_x = printer.configfile.config["stepper_x"]["position_max"]|float %}
    {% set max_y = printer.configfile.config["stepper_y"]["position_max"]|float %}
    {% set max_z = printer.configfile.config["stepper_z"]["position_max"]|float %}

    # Safe Z lift
    {% if printer.toolhead.position.z < (max_z - 40) %}
        {% set z_safe = 40.0 %}
    {% else %}
        {% set z_safe = max_z - printer.toolhead.position.z %}
    {% endif %}

    # Material-specific heater handling
    {% if last_material == "PC" %}
        M118 PRINT_END: PC detected - starting 1.5h anneal.
        SET_DISPLAY_TEXT MSG="PC anneal (bed hot)..."

        M118 PRINT_END: Turning off hotend only...
        SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0

        {% if printer['fan_generic Nevermore'] %}
            M118 PRINT_END: Nevermore ON full speed for anneal...
            SET_FAN_SPEED FAN=Nevermore SPEED=1.0
        {% endif %}

        M118 PRINT_END: Scheduling PC_ANNEAL_END in 5400s...
        UPDATE_DELAYED_GCODE ID=PC_ANNEAL_END DURATION=5400

    {% else %}
        M118 PRINT_END: Non-PC - turning off all heaters...
        SET_DISPLAY_TEXT MSG="Cooling down..."
        TURN_OFF_HEATERS
    {% endif %}

    # Part cooling off
    M107
    M118 PRINT_END: Part cooling fan off.

    # Park toolhead
    M118 PRINT_END: Parking toolhead...
    G91
    G1 Z{z_safe} F600
    G90
    G1 X{max_x - 10} Y{max_y - 20} F6000

    # Enclosure fans
    M118 PRINT_END: Starting enclosure fan timers...
    {% if printer['fan_generic exhaust_fan'] %}
        TIMED_EXHAUST delay=300 power=100
    {% endif %}
    {% if printer['fan_generic cooling_fan'] %}
        TIMED_COOLING delay=300 power=100
    {% endif %}
    {% if printer['fan_generic intake_fan'] %}
        TIMED_INTAKE delay=300 power=100
    {% endif %}
    {% if last_material != "PC" and printer['fan_generic Nevermore'] %}
        TIMED_NEVERMORE delay=300 power=0
    {% endif %}

    M84
    PI_FAN_IDLE

    CLEAR_PAUSE
    STATUS_READY

    {% if last_material == "PC" %}
        M118 PRINT_END: PC anneal running - do NOT remove part yet.
        SET_DISPLAY_TEXT MSG="Annealing PC - do not remove"
    {% else %}
        M118 PRINT_END: Print finished - safe to remove part.
        SET_DISPLAY_TEXT MSG="Print done - remove part"
    {% endif %}

    M118 ================= PRINT_END COMPLETE =================